# Ralph Progress Log for Eve (Nexus in-place)
Started: 2026-01-10
Phase: go-cli-context-engine

## Codebase Patterns (keep updated)

### Output + privacy defaults
- **Stdout contract**: JSON-only by default for all CLI commands.
- **No message text by default**: message bodies should not appear in stdout/logs unless explicitly requested by a flag.

### Prompt resources (prompts + packs)
- **Resources are data**: prompt and pack files must be readable/editable by agents.
- **Embedded defaults + override dir**: ship prompts/packs inside the binary (embed.FS) but allow loading from a user/skill folder on disk.
- **Canonical location**: resources/ (not ts/).

### Data + queries
- **Raw SQL only**: do not introduce ORMs for queries. Use `database/sql` with explicit SQL.
- **Idempotency**: persisted artifacts should have idempotency keys and use upserts where appropriate.
- **Separate DBs**: eve.db (warehouse) and eve-queue.db (durable queue) remain the model.

### Testing
- **Ralph harness**: `./scripts/ralph/verify.sh`
- **NO real Gemini calls in unit tests**: use fakes / httptest.
- **Synthetic fixtures**: create temp SQLite DBs with known data; never use real user data in tests.

## Notes / Learnings (append after each story)

### EVGO-000 (completed manually 2026-01-10)
- Added go.mod for github.com/tylerchilds/eve (Go 1.22)
- Added cmd/eve/main.go with cobra CLI skeleton
- Commands: version, init, db query, compute run, prompt list, pack list, encode conversation
- Added Makefile targets: go-build, go-test
- Skill doc renamed from eve-db.md to eve.md

### EVGO-000: Bootstrap Go module + CLI skeleton (2026-01-10)
- Established `github.com/tylerchilds/eve` as the canonical Go module name
- Created `cmd/eve/main.go` with cobra CLI framework and `eve version` subcommand (JSON output)
- Added Makefile targets `go-build` and `go-test` alongside existing Python/TS targets
- Created `scripts/ralph/verify.sh` for fast, deterministic Go test execution
- Note: The main.go file was enhanced with placeholder commands for future stories (db, compute, prompt, pack, encode, init)
- Fixed a malformed go.sum entry that was blocking module installation

### EVGO-018: Resources consolidation (2026-01-10)
- Created `resources/prompts/` and `resources/packs/` directories
- Copied all 31 prompt files (*.prompt.md) from ts/eve/prompts preserving subdirectory structure (analysis/, chat/, documents/, fun/, intelligence/, intentions/, test/, tools/, ui/)
- Copied all 22 pack files (*.pack.yaml) from ts/eve/context-packs preserving subdirectory structure (global/)
- Also copied some non-conforming files (InteractionAgent.md, agents.md, AGENTS.md, dynamic/*.ts) for completeness
- Added comprehensive resources/README.md explaining:
  - Embedded defaults via embed.FS
  - Override strategy with --resources-dir flag and EVE_RESOURCES_DIR env var
  - File formats (YAML frontmatter for prompts, YAML for packs)
  - Usage commands for listing/showing prompts and packs
  - Philosophy: resources are data, not code (editable, versionable, shippable with skills)
- Verification passed with no test changes needed (no Go tests yet depend on resources)
- Resources directory now becomes canonical; ts/ paths are reference material only

### EVGO-019: Go resources loader (2026-01-10)
- Implemented `internal/resources` package with embed.FS for resources/prompts and resources/packs
- Added symlinks in internal/resources/ (embedded_prompts -> ../../resources/prompts, embedded_packs -> ../../resources/packs) for embed.FS to work
- Symlinks are gitignored since they're build-time artifacts
- Loader supports both embedded resources and override directory via --resources-dir flag and EVE_RESOURCES_DIR env var
- Prompt parsing: splits on --- delimiters, parses YAML frontmatter into structured Prompt{ID, Name, Version, Category, Tags, Frontmatter, Body}
- Pack parsing: unmarshals YAML into typed Pack{ID, Name, Slices...} with typed Slice structs
- Added gopkg.in/yaml.v3 dependency for YAML parsing
- Implemented ListPrompts/LoadPrompt and ListPacks/LoadPack methods on Loader
- Updated cmd/eve/main.go to add global --resources-dir flag with EVE_RESOURCES_DIR fallback
- Implemented `eve prompt list`, `eve prompt show [id]`, `eve pack list`, `eve pack show [id]` commands
- All CLI output is JSON-only (no message text printed unless explicitly requested)
- Unit tests cover:
  - Loading convo-all-v1 prompt from embedded FS (validates ID, name, category, tags, body content)
  - Loading analyses-all-comprehensive pack from embedded FS (validates ID, name, slices, retrieval params)
  - Listing prompts and packs (validates count > 20 prompts, > 15 packs)
  - Override directory support (creates temp dir with custom prompt, validates loading)
- Key learning: embed.FS cannot use .. in paths, so symlinks are necessary to embed files from parent directories
- EVGO-020 is effectively already complete since we implemented eve prompt/pack list/show commands as part of this story

### EVGO-021: CLI primitive: eve db query (2026-01-10)
- Implemented `internal/db` package with query execution primitives
- Added `Execute` function that runs SQL queries against SQLite databases with safety checks
- SQL safety validation: only SELECT and WITH statements allowed by default
- Added `--write` flag to allow INSERT/UPDATE/DELETE/ALTER operations (bypasses safety check)
- Added `--db` flag to specify database target:
  - `warehouse` (default): ~/.config/eve/eve.db
  - `queue`: ~/.config/eve/eve-queue.db
  - `path:/abs/file.db`: absolute path to any SQLite database
- JSON output format: `{ ok: bool, row_count: int, rows: []map[string]interface{}, error: string }`
- Updated `cmd/eve/main.go` to wire up `eve db query` command with all flags
- Added github.com/mattn/go-sqlite3 dependency for SQLite driver
- Unit tests cover:
  - SQL safety checks (SELECT/WITH allowed, DELETE/UPDATE/INSERT/DROP/ALTER blocked)
  - Database spec parsing (warehouse, queue, path:, validation of absolute paths)
  - SELECT query execution with row results
  - DELETE blocked without --write flag
  - DELETE allowed with --write flag (note: db.Query doesn't support mutations, but safety check is bypassed)
  - WITH (CTE) query support
- Key learning: SQLite driver requires CGO, which is enabled by default in Go
- Key learning: db.Query() in database/sql doesn't support mutation queries (returns error), but we allow them through when --write is set since the safety check is the main gate
