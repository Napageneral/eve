# Ralph Progress Log for Eve
Started: 2026-01-08

## Codebase Patterns (keep updated)

### Output + privacy defaults
- **Stdout contract**: JSON-only by default for all CLI commands.
- **No message text by default**: message bodies should not appear in stdout/logs unless explicitly requested (e.g., `--include-text`).
- **JSONL when streaming**: prefer `--jsonl` (one JSON object per line) for progress streams.

### Data + queries
- **Raw SQL only**: do not introduce ORMs for queries. Use `database/sql` with explicit SQL.
- **Idempotency**: every persisted artifact must have a unique idempotency key and use upserts.
- **Separate DBs**: prefer `eve.db` (warehouse) and `eve-queue.db` (durable queue) to avoid lock contention.

### Testing
- **Ralph harness**: `make ralph-verify`
- **NO real Gemini calls in unit tests**: use `httptest` fake servers.
- **NO real-data ETL in the loop**: keep tests deterministic and cheap.

### Go rewrite conventions
- **Single binary**: no Python runtime required for the happy path.
- **No gRPC client stacks**: Gemini calls via HTTP/2 REST only.
- **Config precedence**: env vars override config file; config file overrides defaults.

## Key Files / Directories

- `docs/ralph/GO_SINGLE_BINARY_PLAN.md` — full design
- `docs/ralph/EXECUTION_CHECKLIST.md` — ordered implementation steps
- `scripts/ralph/prd.json` — task list for Ralph
- `scripts/ralph/prompt.md` — loop instructions
- `Makefile` — includes `ralph-verify`

---

## Story Progress (append after each story)

(Append learnings after each story in this format)

### [STORY-ID] (YYYY-MM-DD)
**Status:** ✅ PASSED | ❌ FAILED
**What changed:**
- ...
**Files changed:**
- ...
**Learnings:**
- ...

---

### EVGO-001 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Created Go module with Cobra CLI framework
- Implemented minimal eve binary with version and paths commands
- Both commands output stable JSON as required
- App directory resolution works across macOS/Linux/Windows

**Files changed:**
- `go.mod` + `go.sum` — Go module with cobra dependency
- `cmd/eve/main.go` — CLI entry point with version and paths commands
- `internal/config/config.go` — Config loading with app dir resolution and env var support

**Learnings:**
- Cobra provides clean CLI structure with automatic help generation
- Config package already implements env var overrides (GEMINI_API_KEY, EVE_GEMINI_ANALYSIS_MODEL, EVE_GEMINI_EMBED_MODEL) which satisfies EVGO-002 acceptance criteria
- JSON encoder with SetIndent provides clean, readable output
- App directory resolution follows platform conventions (Library/Application Support on macOS)
- Verification harness runs successfully with go.mod present

---

### EVGO-002 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Verified that EVGO-001 implementation already satisfies EVGO-002 requirements
- Config loading with env var precedence is fully functional
- All three required env vars are supported with appropriate defaults

**Files changed:**
- No new changes; `internal/config/config.go` from EVGO-001 already implements all requirements

**Learnings:**
- Config.Load() reads GEMINI_API_KEY with empty string default (line 51)
- EVE_GEMINI_ANALYSIS_MODEL defaults to "gemini-3.0-flash" (line 52)
- EVE_GEMINI_EMBED_MODEL defaults to "text-embedding-005" (line 53)
- ConfigPath correctly resolves to app_dir/config.json (line 50)
- getEnv helper provides clean env override pattern
- EVGO-001 and EVGO-002 were implemented together efficiently


### EVGO-003 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Created migration runner package using go:embed for SQL files
- Implemented queue DB schema (jobs + runs tables with proper indexes)
- Implemented warehouse DB watermark table for ETL tracking
- Added `eve init` command that creates/migrates both databases
- Migration tracking via schema_migrations table ensures idempotency

**Files changed:**
- `internal/migrate/migrate.go` — migration runner with embedded SQL support
- `internal/migrate/migrate_test.go` — comprehensive unit tests for migrations
- `internal/migrate/sql/queue/001_init.sql` — queue DB schema (jobs + runs)
- `internal/migrate/sql/warehouse/001_watermarks.sql` — watermark tracking table
- `cmd/eve/main.go` — added init command with JSON output
- `go.mod` + `go.sum` — added sqlite3 driver dependency

**Learnings:**
- go:embed requires files to be in the same package or subdirectories (cannot use ../)
- Moved migrations from assets/ to internal/migrate/sql/ to work with embed
- Migration runner uses transaction per migration for atomicity
- schema_migrations table tracks applied migrations by filename + timestamp
- SQLite PRAGMA foreign_keys must be enabled explicitly
- Idempotency achieved by checking schema_migrations before running each migration
- Jobs table uses CHECK constraint for state validation (pending|leased|succeeded|failed|dead)
- Partial indexes (WHERE clause) optimize queue operations for leased/pending jobs
- Separate eve-queue.db prevents lock contention between queue and warehouse writes
- All acceptance criteria met: embedded SQL, idempotent init, queue schema with jobs table

### EVGO-004 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Implemented complete durable queue system with all core primitives
- Enqueue: idempotent job insertion via unique key constraint
- Lease: atomic batch leasing with lease_owner and lease_expires_ts
- RequeueExpired: moves expired leases back to pending state
- Ack: marks jobs as succeeded
- Fail: handles retry with exponential backoff or moves to dead state after max attempts
- 17 comprehensive unit tests covering all operations and edge cases

**Files changed:**
- `internal/queue/queue.go` — complete queue implementation with all primitives
- `internal/queue/queue_test.go` — 17 deterministic unit tests using temp SQLite files
- `go.mod` + `go.sum` — added github.com/google/uuid dependency

**Learnings:**
- Idempotent enqueue uses `INSERT ... ON CONFLICT(key) DO NOTHING` to skip duplicates
- Lease operation requires transaction to atomically query + update job state
- Building dynamic IN clauses in Go requires careful placeholder management
- RequeueExpired is scheduler's responsibility to call periodically
- Exponential backoff: 2^attempts seconds (1s, 2s, 4s, 8s, etc.)
- Job failure checks attempts vs max_attempts to decide between pending and dead state
- sql.NullString and sql.NullInt64 handle optional lease_owner/lease_expires_ts fields
- Unit tests use os.CreateTemp for deterministic temporary SQLite databases
- All tests pass without any external services (no Gemini, no real data)
- Queue design supports high-concurrency leasing by multiple workers
- Lease TTL ensures jobs don't get stuck if worker crashes
- All acceptance criteria met: idempotent enqueue, lease with TTL, requeue expired, comprehensive tests

### EVGO-005 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Added GetStats() method to queue package for operational visibility
- Implemented 'eve compute status' CLI command that outputs JSON
- Returns counts for all job states (pending/leased/succeeded/failed/dead)
- Includes oldest pending job timestamp for backlog age monitoring
- Added comprehensive unit tests for GetStats (empty queue + mixed states)

**Files changed:**
- `internal/queue/queue.go` — added Stats struct and GetStats() method
- `internal/queue/queue_test.go` — added TestGetStats_Empty and TestGetStats_WithJobs
- `cmd/eve/main.go` — added compute command group with status subcommand

**Learnings:**
- GROUP BY aggregation in SQLite efficiently counts jobs by state
- sql.NullInt64 correctly handles optional oldest_ts when queue is empty
- JSON struct tags with omitempty prevent zero values from cluttering output
- Compute command follows Cobra subcommand pattern (compute -> status)
- Stats query is read-only and works without any background services
- omitempty on oldest_pending_ts ensures clean JSON when no pending jobs
- Agent-friendly JSON output enables programmatic queue monitoring
- This is the first operational command that doesn't modify any data
- All acceptance criteria met: JSON output, all state counts, no background services required

### EVGO-006 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Implemented complete Gemini HTTP client with HTTP/2 support
- Added generateContent API for analysis calls (Gemini Flash 3.0)
- Added embedContent API for embedding calls
- Implemented exponential backoff retry logic with jitter
- Comprehensive unit tests using httptest (no real API calls)

**Files changed:**
- `internal/gemini/client.go` — Full HTTP/2 client implementation
- `internal/gemini/client_test.go` — 11 comprehensive unit tests with httptest fake servers

**Learnings:**
- HTTP/2 enabled via Transport.ForceAttemptHTTP2 flag
- Connection pooling configured with MaxIdleConns=100, MaxConnsPerHost=50
- Retry logic: 429 and 5xx status codes are retryable, 4xx (except 429) are not
- Exponential backoff: initialBackoff * 2^(attempt-1) with ±25% jitter
- Backoff capped at maxBackoff (30s) to prevent infinite waits
- math/rand used for jitter to avoid thundering herd on retries
- httptest.NewServer provides deterministic fake HTTP server for tests
- atomic.AddInt32/LoadInt32 used for thread-safe attempt counters in tests
- Client uses 60s default timeout to allow for slow Gemini responses
- JSON marshaling/unmarshaling tests verify request/response struct correctness
- All tests are deterministic and cheap (no external API dependencies)
- All acceptance criteria met: both API methods implemented, retry logic with jitter, httptest-based unit tests
