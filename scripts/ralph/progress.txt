# Ralph Progress Log for Eve
Started: 2026-01-08
Phase: go-etl-complete

## Codebase Patterns (keep updated)

### Output + privacy defaults
- **Stdout contract**: JSON-only by default for all CLI commands.
- **No message text by default**: message bodies should not appear in stdout/logs unless explicitly requested.

### Data + queries
- **Raw SQL only**: do not introduce ORMs for queries. Use `database/sql` with explicit SQL.
- **Idempotency**: every persisted artifact must have a unique idempotency key and use upserts (ON CONFLICT DO UPDATE/IGNORE).
- **Separate DBs**: eve.db (warehouse) and eve-queue.db (durable queue).

### Testing
- **Ralph harness**: `./scripts/ralph/verify.sh`
- **NO real Gemini calls in unit tests**: use `httptest` fake servers.
- **Synthetic fixtures for ETL tests**: create temp chat.db with known data, verify eve.db output.

### Go conventions
- **Single binary**: no Python runtime required.
- **Apple timestamps**: nanoseconds since 2001-01-01 (add 978307200 to convert to Unix).
- **Config precedence**: env vars > config file > defaults.

## Key Files

- `internal/etl/chatdb.go` — chat.db reader (already implemented)
- `internal/etl/watermark.go` — watermark tracking (already implemented)
- `internal/migrate/sql/warehouse/002_core_schema.sql` — target schema
- `cmd/eve/main.go` — CLI entry point

## Previous Phase Summary (EVGO-001 to EVGO-010)

All 10 stories passed:
- Go module + CLI skeleton
- Config loading with env overrides
- Embedded SQL migrations
- Durable queue (enqueue/lease/ack/fail)
- Gemini HTTP client with retries
- Compute engine with worker pools
- Analysis job handler
- Embeddings pipeline with batching
- ETL bootstrap (message count + watermark only)

**Gap**: `eve sync` currently only counts messages and updates watermark. It does NOT copy data.

---

## Story Progress (append after each story)

### EVGO-011 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Implemented SyncHandles() to copy handles from chat.db to eve.db
- Reads all handles with ROWID and identifier from chat.db handle table
- Inserts into contacts table using handle ROWID as contact_id (preserves FK references)
- Inserts into contact_identifiers with type detection (email if contains @, else phone)
- Idempotent via check-before-insert pattern (no UNIQUE constraint on contact_identifiers yet)
**Files changed:**
- internal/etl/handles.go (new)
- internal/etl/handles_test.go (new)
**Learnings:**
- Handle ROWID → contact_id mapping is critical for FK consistency with messages later
- contact_identifiers schema lacks UNIQUE constraint, so used check-then-insert for idempotency
- Simple @ detection works for email vs phone classification
- Test helper naming collision: renamed to createTestWarehouseDBWithContacts() to avoid conflict with watermark_test.go

---
### EVGO-012 (2026-01-08)
**Status:** ✅ PASSED
**What changed:**
- Implemented SyncChats() to copy chats from chat.db to eve.db
- Reads all chats with ROWID, chat_identifier, display_name, service_name, and style
- Inserts into chats table using chat ROWID as id (preserves FK references for messages)
- Maps style field to is_group boolean: style=43 is group chat, style=45 is 1:1 chat
- Idempotent via chat_identifier UNIQUE constraint with ON CONFLICT DO UPDATE
- Handles nullable display_name and service_name fields properly
**Files changed:**
- internal/etl/chats.go (new)
- internal/etl/chats_test.go (new)
**Learnings:**
- Chat ROWID → chats.id mapping is critical for FK consistency with messages table
- Style values 43 (group) and 45 (1:1) are the primary indicators of chat type in iMessage
- chat_identifier already has UNIQUE constraint in schema, so ON CONFLICT DO UPDATE works cleanly
- Nullable fields need sql.NullString handling when reading, but can store empty strings on write
- Test pattern consistent with handles_test.go: synthetic fixture creation + comprehensive edge case coverage

---

